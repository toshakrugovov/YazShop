{% extends 'base.html' %}
{% load static %}
{% block title %}–í—Ö–æ–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - YazShop{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/login.css' %}">
<link rel="stylesheet" href="{% static 'css/login_modal.css' %}">
{% endblock %}
{% block content %}
<div class="login-content">
  <div class="login-container">
    <form class="login-form" id="loginForm" novalidate>
      {% csrf_token %}
      <h2>–í—Ö–æ–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>

      {% if messages %}
        {% for message in messages %}
          {% comment %}–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞{% endcomment %}
          {% if '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' in message|lower or 'https://t.me/toshaplenka' in message|stringformat:"s" %}
            <div class="error-message show django-message" style="display: block;" data-message="{{ message }}">
              {{ message }}
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
      <div class="error-message" id="errorMessage"></div>
      <div class="success-message" id="successMessage"></div>

      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" id="email" name="email" placeholder="your@email.com" required autocomplete="email">
      </div>

      <div class="form-group" id="passwordGroup">
        <label for="password">–ü–∞—Ä–æ–ª—å</label>
        <div class="input-wrapper">
          <input type="password" id="password" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" autocomplete="current-password" disabled>
          <button type="button" class="toggle-password" data-target="password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
        </div>
      </div>

      <button type="submit" class="btn" id="submitBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>

      <button type="button" class="btn btn-secondary" id="registerBtn" onclick="window.location.href='/register/'">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

      <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
      <div style="text-align: center; margin-top: 16px;">
        <a href="#" class="forgot-link" id="forgotLink">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
        <div style="margin-top: 8px; font-size: 13px; color: var(--text-color-secondary);">
          –ï—Å–ª–∏ –∑–∞–±—ã–ª–∏ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ 
          <a href="https://t.me/toshaplenka" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">–ø–æ–¥–¥–µ—Ä–∂–∫—É</a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è -->
<div class="modal" id="passwordRecoveryModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h3>
      <button class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å" id="modalCloseBtn">√ó</button>
    </div>
    <div class="modal-body">
      <div class="step step-1">
        <div class="form-group">
          <label for="fp_phone">–¢–µ–ª–µ—Ñ–æ–Ω (–†–æ—Å—Å–∏—è)</label>
          <input type="tel" id="fp_phone" placeholder="+7 999 123-45-67" inputmode="tel">
          <div class="error" id="fp_phone_err">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX</div>
        </div>
        <div class="form-group">
          <label for="fp_email">Email</label>
          <input type="email" id="fp_email" placeholder="you@example.com">
          <div class="error" id="fp_email_err">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>
        </div>
        <div class="form-group">
          <label for="fp_fname">–ò–º—è</label>
          <input type="text" id="fp_fname" placeholder="–ò–≤–∞–Ω">
          <div class="error" id="fp_fname_err">–£–∫–∞–∂–∏—Ç–µ –∏–º—è</div>
        </div>
        <div class="form-group">
          <label for="fp_lname">–§–∞–º–∏–ª–∏—è</label>
          <input type="text" id="fp_lname" placeholder="–ò–≤–∞–Ω–æ–≤">
          <div class="error" id="fp_lname_err">–£–∫–∞–∂–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é</div>
        </div>
        <div class="form-group">
          <label for="fp_secret_word">–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ</label>
          <div class="input-wrapper">
            <input type="password" id="fp_secret_word" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ">
            <button type="button" class="toggle-password" data-target="fp_secret_word" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ">üëÅ</button>
          </div>
          <div class="error" id="fp_secret_word_err">–£–∫–∞–∂–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ</div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" id="fp_cancel">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn" id="fp_next">–î–∞–ª–µ–µ</button>
        </div>
      </div>
      <div class="step step-2 hidden">
        <div class="form-group">
          <label for="fp_pass1">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
          <div class="input-wrapper">
            <input type="password" id="fp_pass1" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            <button type="button" class="toggle-password" data-target="fp_pass1" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
          </div>
          <div class="error" id="fp_pass1_err">–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –≤–µ—Ä—Ö–Ω–µ–≥–æ –∏ –Ω–∏–∂–Ω–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ —Ü–∏—Ñ—Ä—ã</div>
        </div>
        <div class="form-group">
          <label for="fp_pass2">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
          <div class="input-wrapper">
            <input type="password" id="fp_pass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button type="button" class="toggle-password" data-target="fp_pass2" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
          </div>
          <div class="error" id="fp_pass2_err">–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç</div>
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" id="fp_back">–ù–∞–∑–∞–¥</button>
          <button class="btn" id="fp_submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        </div>
      </div>
      <div class="error error-common" style="display:none;"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ Django messages —Å —Å—Å—ã–ª–∫–∞–º–∏
    const djangoMessages = document.querySelectorAll('.django-message');
    djangoMessages.forEach(function(msg) {
      const messageText = msg.getAttribute('data-message') || msg.textContent;
      if (messageText.includes('https://t.me/toshaplenka')) {
        msg.innerHTML = messageText.replace('https://t.me/toshaplenka', '<a href="https://t.me/toshaplenka" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">https://t.me/toshaplenka</a>');
      }
    });
    const form = document.getElementById('loginForm');
    const emailInput = document.getElementById('email');
    const passwordGroup = document.getElementById('passwordGroup');
    const passwordInput = document.getElementById('password');
    const registerBtn = document.getElementById('registerBtn');
    const submitBtn = document.getElementById('submitBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    let emailChecked = false;
    let emailExists = false;

    function showError(message) {
      // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTML –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ–± –æ—à–∏–±–∫–∞—Ö (–¥–ª—è —Å—Å—ã–ª–æ–∫)
      errorMessage.innerHTML = message;
      errorMessage.classList.add('show');
      successMessage.classList.remove('show');
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.classList.add('show');
      errorMessage.classList.remove('show');
    }

    function hideMessages() {
      errorMessage.classList.remove('show');
      successMessage.classList.remove('show');
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      if (!cookieValue) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
          cookieValue = csrfInput.value;
        }
      }
      return cookieValue;
    }

    async function checkEmail(email) {
      try {
        const response = await fetch('/api/check-email/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin',
          body: JSON.stringify({ email: email })
        });

        if (!response.ok) {
          let errorData;
          try {
            errorData = await response.json();
          } catch (e) {
            errorData = { error: `HTTP error! status: ${response.status}` };
          }
          throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data.exists === true;
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ email: ' + error.message);
        return null;
      }
    }

    async function login(email, password) {
      try {
        const response = await fetch('/api/login/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin',
          body: JSON.stringify({ email: email, password: password })
        });

        const data = await response.json();

        if (!response.ok) {
          return { success: false, error: data.error || '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏' };
        }

        return data;
      } catch (error) {
        return { success: false, error: '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message };
      }
    }

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      hideMessages();
      submitBtn.disabled = true;
      submitBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';

      const email = emailInput.value.trim();

      if (!email) {
        showError('–í–≤–µ–¥–∏—Ç–µ email');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        return;
      }

      if (!emailChecked) {
        const result = await checkEmail(email);
        if (result === null) {
          submitBtn.disabled = false;
          submitBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
          return;
        }
        emailExists = result === true;
        emailChecked = true;

        if (emailExists) {
          passwordGroup.classList.add('show');
          passwordInput.disabled = false;
          passwordInput.setAttribute('required', 'required');
          registerBtn.classList.remove('show');
          submitBtn.style.display = '';
          passwordInput.focus();
          submitBtn.textContent = '–í–æ–π—Ç–∏';
          submitBtn.disabled = false;
        } else {
          registerBtn.classList.add('show');
          passwordGroup.classList.remove('show');
          showError('–ê–∫–∫–∞—É–Ω—Ç —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω');
          submitBtn.disabled = false;
          submitBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
          submitBtn.style.display = 'none';
        }
      } else if (emailExists) {
        const password = passwordInput.value;
        if (!password) {
          showError('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
          submitBtn.disabled = false;
          return;
        }

        submitBtn.textContent = '–í—Ö–æ–¥...';
        const result = await login(email, password);
        if (result.success) {
          showSuccess('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
          submitBtn.disabled = true;
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
        } else {
          let errorMsg = result.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
          // –î–µ–ª–∞–µ–º —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –æ–± –æ—à–∏–±–∫–∞—Ö
          if (errorMsg.includes('https://t.me/toshaplenka')) {
            errorMsg = errorMsg.replace('https://t.me/toshaplenka', '<a href="https://t.me/toshaplenka" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">https://t.me/toshaplenka</a>');
          }
          showError(errorMsg);
          submitBtn.disabled = false;
          submitBtn.textContent = '–í–æ–π—Ç–∏';
          passwordInput.value = '';
        }
      }
    });

    emailInput.addEventListener('input', function () {
      if (emailChecked) {
        emailChecked = false;
        emailExists = false;
        passwordGroup.classList.remove('show');
        passwordInput.disabled = true;
        passwordInput.removeAttribute('required');
        registerBtn.classList.remove('show');
        passwordInput.value = '';
        submitBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        submitBtn.style.display = '';
        hideMessages();
      }
    });

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –∏ –ª–æ–≥–∏–∫–∞
    const modal = document.getElementById('passwordRecoveryModal');
    const forgotLink = document.getElementById('forgotLink');
    const closeBtn = document.getElementById('modalCloseBtn');
    const cancelBtn = modal.querySelector('#fp_cancel');
    const nextBtn = modal.querySelector('#fp_next');
    const backBtn = modal.querySelector('#fp_back');
    const submitNewBtn = modal.querySelector('#fp_submit');

    function openModal() {
      resetRecoveryForm();
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
    }

    forgotLink.addEventListener('click', (e) => {
      e.preventDefault();
      openModal();
    });
    closeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      resetRecoveryForm();
      closeModal();
    });
    cancelBtn.addEventListener('click', (e) => {
      e.preventDefault();
      resetRecoveryForm();
      closeModal();
    });
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        resetRecoveryForm();
        closeModal();
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('open')) {
        resetRecoveryForm();
        closeModal();
      }
    });

    function validatePhone(v) {
      const d = v.replace(/\D/g, '').replace(/^8/, '7');
      return /^7\d{10}$/.test(d);
    }

    function validateEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }

    function formatRuPhone(v) {
      const d = v.replace(/\D/g, '').replace(/^8/, '7');
      const s = d.slice(0, 11);
      let out = '+7';
      if (s.length > 1) out += ' (' + s.slice(1, 4);
      if (s.length >= 4) out += ') ' + s.slice(4, 7);
      if (s.length >= 7) out += '-' + s.slice(7, 9);
      if (s.length >= 9) out += '-' + s.slice(9, 11);
      return out;
    }

    modal.addEventListener('input', function (e) {
      if (e.target && e.target.id === 'fp_phone') {
        e.target.value = formatRuPhone(e.target.value);
      }
    });

    nextBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const phone = document.getElementById('fp_phone');
      const email = document.getElementById('fp_email');
      const fname = document.getElementById('fp_fname');
      const lname = document.getElementById('fp_lname');
      const secretWord = document.getElementById('fp_secret_word');
      let ok = true;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∞ –ø–æ–ª–µ–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
      const phoneVal = phone.value.trim();
      const normalized = phoneVal.replace(/\D/g, '').replace(/^8/, '7');
      const phoneOk = /^7\d{10}$/.test(normalized);
      if (!phoneOk) {
        document.getElementById('fp_phone_err').classList.add('show');
        ok = false;
      } else {
        document.getElementById('fp_phone_err').classList.remove('show');
      }
      if (!validateEmail(email.value.trim())) {
        document.getElementById('fp_email_err').classList.add('show');
        ok = false;
      } else {
        document.getElementById('fp_email_err').classList.remove('show');
      }
      if (!fname.value.trim()) {
        document.getElementById('fp_fname_err').classList.add('show');
        ok = false;
      } else {
        document.getElementById('fp_fname_err').classList.remove('show');
      }
      if (!lname.value.trim()) {
        document.getElementById('fp_lname_err').classList.add('show');
        ok = false;
      } else {
        document.getElementById('fp_lname_err').classList.remove('show');
      }
      if (!secretWord.value.trim()) {
        document.getElementById('fp_secret_word_err').classList.add('show');
        ok = false;
      } else {
        document.getElementById('fp_secret_word_err').classList.remove('show');
      }
      
      const commonErr = ensureCommonErr();
      if (!ok) {
        commonErr.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ';
        commonErr.style.display = 'block';
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫–æ –≤—Ç–æ—Ä–æ–º—É —à–∞–≥—É
      commonErr.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
      commonErr.style.display = 'block';
      commonErr.style.color = '';
      nextBtn.disabled = true;
      
      try {
        const response = await fetch('/api/verify-reset-data/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          credentials: 'same-origin',
          body: JSON.stringify({
            phone: normalized,
            email: email.value.trim(),
            first_name: fname.value.trim(),
            last_name: lname.value.trim(),
            secret_word: secretWord.value.trim()
          })
        });
        const result = await response.json();
        
        if (!response.ok || !result.success) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—à–∏–±–∫—É
          let errorMessage = result.error || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–µ –ø–æ–ª–µ –Ω–µ–≤–µ—Ä–Ω–æ, –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
          if (errorMessage.includes('email') || errorMessage.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω')) {
            document.getElementById('fp_email_err').textContent = errorMessage;
            document.getElementById('fp_email_err').classList.add('show');
          } else if (errorMessage.includes('—Ç–µ–ª–µ—Ñ–æ–Ω') || errorMessage.includes('–Ω–æ–º–µ—Ä')) {
            document.getElementById('fp_phone_err').textContent = errorMessage;
            document.getElementById('fp_phone_err').classList.add('show');
          } else if (errorMessage.includes('–∏–º—è') || errorMessage.includes('—Ñ–∞–º–∏–ª–∏—è')) {
            if (errorMessage.includes('–∏–º—è')) {
              document.getElementById('fp_fname_err').textContent = errorMessage;
              document.getElementById('fp_fname_err').classList.add('show');
            }
            if (errorMessage.includes('—Ñ–∞–º–∏–ª–∏—è')) {
              document.getElementById('fp_lname_err').textContent = errorMessage;
              document.getElementById('fp_lname_err').classList.add('show');
            }
          } else if (errorMessage.includes('—Å–µ–∫—Ä–µ—Ç–Ω')) {
            document.getElementById('fp_secret_word_err').textContent = errorMessage;
            document.getElementById('fp_secret_word_err').classList.add('show');
          }
          
          // –î–µ–ª–∞–µ–º —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
          let displayMessage = errorMessage;
          if (errorMessage.includes('https://t.me/toshaplenka')) {
            displayMessage = errorMessage.replace('https://t.me/toshaplenka', '<a href="https://t.me/toshaplenka" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">https://t.me/toshaplenka</a>');
          }
          commonErr.innerHTML = displayMessage;
          commonErr.style.display = 'block';
          commonErr.style.color = '#e74c3c';
          return;
        }
        
        // –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫–æ –≤—Ç–æ—Ä–æ–º—É —à–∞–≥—É
        commonErr.style.display = 'none';
        modal.querySelector('.step-1').classList.add('hidden');
        modal.querySelector('.step-2').classList.remove('hidden');
      } catch (err) {
        let errorMsg = err.message || '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
        // –î–µ–ª–∞–µ–º —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
        if (errorMsg.includes('https://t.me/toshaplenka')) {
          errorMsg = errorMsg.replace('https://t.me/toshaplenka', '<a href="https://t.me/toshaplenka" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">https://t.me/toshaplenka</a>');
        }
        commonErr.innerHTML = errorMsg;
        commonErr.style.display = 'block';
        commonErr.style.color = '#e74c3c';
      } finally {
        nextBtn.disabled = false;
      }
    });

    backBtn.addEventListener('click', (e) => {
      e.preventDefault();
      modal.querySelector('.step-2').classList.add('hidden');
      modal.querySelector('.step-1').classList.remove('hidden');
    });

    submitNewBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      const pass1 = document.getElementById('fp_pass1');
      const pass2 = document.getElementById('fp_pass2');
      let ok = true;
      function strong(p) {
        return /[A-Z–ê-–Ø]/.test(p) && /[a-z–∞-—è]/.test(p) && /\d/.test(p) && p.length >= 8;
      }
      if (!pass1.value || !strong(pass1.value)) {
        document.getElementById('fp_pass1_err').textContent = '–ù–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤, –±—É–∫–≤—ã –≤–µ—Ä—Ö/–Ω–∏–∑ –∏ —Ü–∏—Ñ—Ä—ã';
        document.getElementById('fp_pass1_err').classList.add('show');
        ok = false;
      } else {
        document.getElementById('fp_pass1_err').classList.remove('show');
      }
      if (pass1.value !== pass2.value) {
        document.getElementById('fp_pass2_err').classList.add('show');
        ok = false;
      } else {
        document.getElementById('fp_pass2_err').classList.remove('show');
      }
      const commonErr2 = ensureCommonErr();
      if (!ok) {
        commonErr2.textContent = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
        commonErr2.style.display = 'block';
        return;
      }

      try {
        const phoneVal = document.getElementById('fp_phone').value.trim();
        const normalized = phoneVal.replace(/\D/g, '').replace(/^8/, '7');
        const response = await fetch('/api/reset-password/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
          credentials: 'same-origin',
          body: JSON.stringify({
            phone: normalized,
            email: document.getElementById('fp_email').value.trim(),
            first_name: document.getElementById('fp_fname').value.trim(),
            last_name: document.getElementById('fp_lname').value.trim(),
            secret_word: document.getElementById('fp_secret_word').value.trim(),
            password: pass1.value
          })
        });
        const result = await response.json();
        if (!response.ok || !result.success) {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è');
        }
        closeModal();
        alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ —Å –Ω–æ–≤—ã–º –ø–∞—Ä–æ–ª–µ–º.');
        window.location.href = '/login/';
      } catch (err) {
        const commonErr2 = ensureCommonErr();
        let errorMsg = err.message || '–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è';
        // –î–µ–ª–∞–µ–º —Å—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
        if (errorMsg.includes('https://t.me/toshaplenka')) {
          errorMsg = errorMsg.replace('https://t.me/toshaplenka', '<a href="https://t.me/toshaplenka" target="_blank" rel="noopener noreferrer" style="color: #007bff; text-decoration: underline;">https://t.me/toshaplenka</a>');
        }
        commonErr2.innerHTML = errorMsg;
        commonErr2.style.display = 'block';
      }
    });

    function toggleType(input) {
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.toggle-password');
      if (!btn) return;
      const targetId = btn.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (input) toggleType(input);
    });

    function ensureCommonErr() {
      let el = modal.querySelector('.error-common');
      if (!el) {
        el = document.createElement('div');
        el.className = 'error error-common';
        modal.querySelector('.modal-body').prepend(el);
      }
      return el;
    }

    function resetRecoveryForm() {
      modal.querySelector('.step-1').classList.remove('hidden');
      modal.querySelector('.step-2').classList.add('hidden');
      ['fp_phone', 'fp_email', 'fp_fname', 'fp_lname', 'fp_secret_word', 'fp_pass1', 'fp_pass2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      document.querySelectorAll('.error').forEach(el => el.classList.remove('show'));
      ensureCommonErr().style.display = 'none';
    }
  });
</script>
{% endblock %}
