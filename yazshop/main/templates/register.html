{% extends 'base.html' %}
{% load static %}

{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - YazShop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/login.css' %}">
{% endblock %}

{% block content %}
<div class="login-content">
    <div class="login-container">
        <form class="login-form" id="registerForm">
            {% csrf_token %}
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <div class="form-group">
                <label for="first_name">–ò–º—è</label>
                <input type="text" id="first_name" name="first_name" placeholder="–ò–≤–∞–Ω" required>
            </div>

            <div class="form-group">
                <label for="last_name">–§–∞–º–∏–ª–∏—è</label>
                <input type="text" id="last_name" name="last_name" placeholder="–ò–≤–∞–Ω–æ–≤" required>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" placeholder="your@email.com" required autocomplete="email">
            </div>

            <div class="form-group">
                <label for="password">–ü–∞—Ä–æ–ª—å</label>
                <div class="input-wrapper">
                    <input type="password" id="password" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required autocomplete="new-password">
                    <button type="button" class="toggle-password" data-target="password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
                </div>
            </div>

            <div class="form-group">
                <label for="password2">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                <div class="input-wrapper">
                    <input type="password" id="password2" name="password2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required autocomplete="new-password">
                    <button type="button" class="toggle-password" data-target="password2" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å">üëÅ</button>
                </div>
            </div>

            <div class="form-group">
                <label for="phone_number">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="phone_number" name="phone_number" placeholder="+7 (___) ___-__-__" required inputmode="tel">
            </div>

            <div class="form-group">
                <label for="birth_date">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="date" id="birth_date" name="birth_date" required>
            </div>

            <div class="form-group">
                <label for="secret_word">–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ</label>
                <div class="input-wrapper">
                    <input type="password" id="secret_word" name="secret_word" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ" autocomplete="off">
                    <button type="button" class="toggle-password" data-target="secret_word" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–ª–æ–≤–æ">üëÅ</button>
                </div>
                <small style="color: var(--text-color-secondary); font-size: 12px; display: block; margin-top: 4px;">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</small>
            </div>

            <button type="submit" class="btn" id="submitBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <a href="/login/" class="back-link">‚Üê –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const form = document.getElementById('registerForm');
const firstNameInput = document.getElementById('first_name');
const lastNameInput = document.getElementById('last_name');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const password2Input = document.getElementById('password2');
const regPhone = document.getElementById('phone_number');
const birthInput = document.getElementById('birth_date');
const secretWordInput = document.getElementById('secret_word');
const submitBtn = document.getElementById('submitBtn');
const errorMessage = document.getElementById('errorMessage');
const successMessage = document.getElementById('successMessage');

// === –§–£–ù–ö–¶–ò–ò ===
function showError(msg) { 
    errorMessage.textContent = msg; 
    errorMessage.classList.add('show'); 
    successMessage.classList.remove('show'); 
}
function showSuccess(msg) { 
    successMessage.textContent = msg; 
    successMessage.classList.add('show'); 
    errorMessage.classList.remove('show'); 
}
function hideMessages() { 
    errorMessage.classList.remove('show'); 
    successMessage.classList.remove('show'); 
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    if (!cookieValue) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) cookieValue = csrfInput.value;
    }
    return cookieValue;
}

// === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è ===
function strong(p) {
    return /[A-Z–ê-–Ø]/.test(p) && /[a-z–∞-—è]/.test(p) && /\d/.test(p) && p.length >= 8;
}

// === –ú–∞—Å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ===
function formatPhone(v) {
    const d = v.replace(/\D/g, '').replace(/^8/, '7');
    const s = d.slice(0, 11);
    let out = '+7';
    if (s.length > 1) out += ' (' + s.slice(1, 4);
    if (s.length >= 4) out += ') ' + s.slice(4, 7);
    if (s.length >= 7) out += '-' + s.slice(7, 9);
    if (s.length >= 9) out += '-' + s.slice(9, 11);
    return out;
}
regPhone.addEventListener('input', function() {
    this.value = formatPhone(this.value);
});

// === –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è ===
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.toggle-password');
    if (!btn) return;
    const id = btn.getAttribute('data-target');
    const input = document.getElementById(id);
    if (input) input.type = input.type === 'password' ? 'text' : 'password';
});

// === –ó–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é ===
async function register(data) {
    try {
        const response = await fetch('/api/register/', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': getCookie('csrftoken') 
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        const result = await response.json();
        return response.ok ? result : { success:false, error: result.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏' };
    } catch(err) {
        return { success:false, error:'–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: '+err.message };
    }
}

// === –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã ===
form.addEventListener('submit', async function(e){
    e.preventDefault();
    hideMessages();
    submitBtn.disabled = true;
    submitBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';

    if (!firstNameInput.value || !lastNameInput.value || !emailInput.value || 
        !passwordInput.value || !password2Input.value || !regPhone.value || !birthInput.value) {
        showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
        return;
    }

    if (passwordInput.value !== password2Input.value) {
        showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
        return;
    }

    if(!strong(passwordInput.value)){
        showError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, –±—É–∫–≤—ã –≤–µ—Ä—Ö/–Ω–∏–∑ –∏ —Ü–∏—Ñ—Ä—ã');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
        return;
    }

    const normalized = regPhone.value.replace(/\D/g, '').replace(/^8/, '7');
    if(!/^7\d{10}$/.test(normalized)){
        showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX (10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +7)');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
        return;
    }

    const data = {
        first_name: firstNameInput.value.trim(),
        last_name: lastNameInput.value.trim(),
        email: emailInput.value.trim(),
        password: passwordInput.value,
        password2: password2Input.value,
        phone_number: normalized,
        birth_date: birthInput.value,
        secret_word: secretWordInput.value.trim()
    };

    const result = await register(data);
    if(result.success){
        showSuccess('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
        setTimeout(() => {
            window.location.href = `/login/?email=${encodeURIComponent(data.email)}`;
        }, 1200);
    } else {
        showError(result.error);
        submitBtn.disabled = false;
        submitBtn.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
    }
});
</script>
{% endblock %}
