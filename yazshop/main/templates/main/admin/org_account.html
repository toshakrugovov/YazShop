{% extends 'base.html' %}
{% load static %}

{% block title %}Счет организации - YazShop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Счет организации</h1>
        <div class="dashboard-actions">
            <a href="{% url 'management_dashboard' %}">← Назад</a>
        </div>
    </div>

    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 32px;">
        <div class="dashboard-card">
            <h3>{{ org_account.balance }} ₽</h3>
            <p>Баланс организации</p>
        </div>
        <div class="dashboard-card">
            <h3>{{ org_account.tax_reserve }} ₽</h3>
            <p>Резерв на налоги (13%)</p>
        </div>
        <div class="dashboard-card">
            <h3>{{ org_account.balance|add:org_account.tax_reserve|floatformat:2 }} ₽</h3>
            <p>Доступно для вывода</p>
        </div>
    </div>

    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 32px;">
        <!-- Вывод средств -->
        <div class="dashboard-card" style="padding: 24px;">
            <h2 style="margin-top: 0;">Вывод средств на карту</h2>
            <form id="withdraw-form" style="margin-top: 20px;">
                {% csrf_token %}
                <div class="form-group">
                    <label for="card_id">Выберите карту:</label>
                    <select name="card_id" id="card_id" required class="form-control">
                        {% for card in admin_cards %}
                        <option value="{{ card.id }}">{{ card.card_type|upper|default:"CARD" }} {{ card.mask_card_number }} (Баланс: {{ card.balance }} ₽)</option>
                        {% empty %}
                        <option disabled>Нет сохраненных карт. <a href="{% url 'payment_methods' %}">Добавить карту</a></option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdraw_amount">Сумма:</label>
                    <input type="number" name="amount" id="withdraw_amount" step="0.01" min="0.01" max="{{ org_account.balance }}" required class="form-control" placeholder="0.00" value="">
                    <small id="withdraw_error" style="color: #e74c3c; display: none; margin-top: 4px;"></small>
                    <small style="color: var(--text-color-secondary);">Доступно: <strong id="available_balance">{{ org_account.balance }}</strong> ₽</small>
                </div>
                <button type="submit" class="btn" id="withdraw_btn" {% if not admin_cards %}disabled{% endif %}>Вывести средства</button>
            </form>
        </div>

        <!-- Оплата налога -->
        <div class="dashboard-card" style="padding: 24px;">
            <h2 style="margin-top: 0;">Оплата налога</h2>
            <form id="pay-tax-form" style="margin-top: 20px;">
                {% csrf_token %}
                <div class="form-group">
                    <label for="tax_amount">Сумма к оплате:</label>
                    <input type="number" name="amount" id="tax_amount" step="0.01" min="0.01" max="{{ org_account.tax_reserve }}" required class="form-control" placeholder="0.00" value="">
                    <small id="tax_error" style="color: #e74c3c; display: none; margin-top: 4px;"></small>
                    <small style="color: var(--text-color-secondary);">Доступно в резерве: <strong id="available_tax_reserve">{{ org_account.tax_reserve }}</strong> ₽</small>
                    <small style="color: var(--text-color-secondary); display: block; margin-top: 4px;">Баланс организации: <strong id="available_balance_tax">{{ org_account.balance }}</strong> ₽</small>
                </div>
                <button type="submit" class="btn" id="pay_tax_btn" {% if org_account.tax_reserve <= 0 %}disabled{% endif %}>Оплатить налог</button>
            </form>
        </div>
    </div>

    <!-- История транзакций -->
    <div class="data-section">
        <h3>История транзакций</h3>
        {% if transactions %}
        <div class="table-wrap">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Тип</th>
                        <th>Сумма</th>
                        <th>Описание</th>
                        <th>Баланс до</th>
                        <th>Баланс после</th>
                        <th>Резерв до</th>
                        <th>Резерв после</th>
                        <th>Пользователь</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in transactions %}
                    <tr>
                        <td>{{ trans.created_at|date:"d.m.Y H:i" }}</td>
                        <td>{{ trans.get_transaction_type_display }}</td>
                        <td>{{ trans.amount }} ₽</td>
                        <td>{{ trans.description|default:"—" }}</td>
                        <td>{{ trans.balance_before }} ₽</td>
                        <td>{{ trans.balance_after }} ₽</td>
                        <td>{{ trans.tax_reserve_before }} ₽</td>
                        <td>{{ trans.tax_reserve_after }} ₽</td>
                        <td>{{ trans.created_by.username|default:"Система" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>Транзакций пока нет.</p>
        {% endif %}
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if(document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for(let cookie of cookies){
            cookie = cookie.trim();
            if(cookie.startsWith(name + '=')){
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    if(!cookieValue){
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if(csrfInput) cookieValue = csrfInput.value;
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const withdrawAmount = document.getElementById('withdraw_amount');
    const withdrawError = document.getElementById('withdraw_error');
    const withdrawBtn = document.getElementById('withdraw_btn');
    const availableBalance = parseFloat(document.getElementById('available_balance').textContent) || 0;
    
    const taxAmount = document.getElementById('tax_amount');
    const taxError = document.getElementById('tax_error');
    const payTaxBtn = document.getElementById('pay_tax_btn');
    const availableTaxReserve = parseFloat(document.getElementById('available_tax_reserve').textContent) || 0;
    const availableBalanceTax = parseFloat(document.getElementById('available_balance_tax').textContent) || 0;
    
    // Валидация вывода средств
    if (withdrawAmount) {
        withdrawAmount.addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            
            if (amount <= 0) {
                withdrawError.textContent = 'Сумма должна быть больше нуля';
                withdrawError.style.display = 'block';
                withdrawBtn.disabled = true;
                this.style.borderColor = '#e74c3c';
            } else if (amount > availableBalance) {
                withdrawError.textContent = `Недостаточно средств. Доступно: ${availableBalance.toFixed(2)} ₽, запрошено: ${amount.toFixed(2)} ₽`;
                withdrawError.style.display = 'block';
                withdrawBtn.disabled = true;
                this.style.borderColor = '#e74c3c';
            } else {
                withdrawError.style.display = 'none';
                withdrawBtn.disabled = false;
                this.style.borderColor = '';
            }
        });
        
        // Обработка отправки формы вывода
        document.getElementById('withdraw-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const amount = parseFloat(withdrawAmount.value) || 0;
            if (amount <= 0 || amount > availableBalance) {
                if (amount > availableBalance) {
                    withdrawError.textContent = `Недостаточно средств. Доступно: ${availableBalance.toFixed(2)} ₽, запрошено: ${amount.toFixed(2)} ₽`;
                    withdrawError.style.display = 'block';
                }
                withdrawAmount.focus();
                return false;
            }
            
            const cardId = document.getElementById('card_id').value;
            withdrawBtn.disabled = true;
            withdrawBtn.textContent = 'Вывод...';
            
            try {
                const response = await fetch('/api/management/org-account/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        action: 'withdraw',
                        amount: amount,
                        card_id: cardId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message || 'Средства успешно выведены');
                    location.reload();
                } else {
                    withdrawError.textContent = result.error || 'Ошибка при выводе средств';
                    withdrawError.style.display = 'block';
                    withdrawBtn.disabled = false;
                    withdrawBtn.textContent = 'Вывести средства';
                }
            } catch(err) {
                withdrawError.textContent = 'Ошибка соединения: ' + err.message;
                withdrawError.style.display = 'block';
                withdrawBtn.disabled = false;
                withdrawBtn.textContent = 'Вывести средства';
            }
        });
    }
    
    // Валидация оплаты налога
    if (taxAmount) {
        taxAmount.addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            
            if (amount <= 0) {
                taxError.textContent = 'Сумма должна быть больше нуля';
                taxError.style.display = 'block';
                payTaxBtn.disabled = true;
                this.style.borderColor = '#e74c3c';
            } else if (amount > availableTaxReserve) {
                taxError.textContent = `Недостаточно средств в резерве на налоги. Доступно: ${availableTaxReserve.toFixed(2)} ₽, запрошено: ${amount.toFixed(2)} ₽`;
                taxError.style.display = 'block';
                payTaxBtn.disabled = true;
                this.style.borderColor = '#e74c3c';
            } else if (amount > availableBalanceTax) {
                taxError.textContent = `Недостаточно средств на счете организации. Доступно: ${availableBalanceTax.toFixed(2)} ₽, запрошено: ${amount.toFixed(2)} ₽`;
                taxError.style.display = 'block';
                payTaxBtn.disabled = true;
                this.style.borderColor = '#e74c3c';
            } else {
                taxError.style.display = 'none';
                payTaxBtn.disabled = false;
                this.style.borderColor = '';
            }
        });
        
        // Обработка отправки формы оплаты налога
        document.getElementById('pay-tax-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const amount = parseFloat(taxAmount.value) || 0;
            if (amount <= 0 || amount > availableTaxReserve || amount > availableBalanceTax) {
                if (amount > availableTaxReserve) {
                    taxError.textContent = `Недостаточно средств в резерве на налоги. Доступно: ${availableTaxReserve.toFixed(2)} ₽, запрошено: ${amount.toFixed(2)} ₽`;
                } else if (amount > availableBalanceTax) {
                    taxError.textContent = `Недостаточно средств на счете организации. Доступно: ${availableBalanceTax.toFixed(2)} ₽, запрошено: ${amount.toFixed(2)} ₽`;
                }
                taxError.style.display = 'block';
                taxAmount.focus();
                return false;
            }
            
            payTaxBtn.disabled = true;
            payTaxBtn.textContent = 'Оплата...';
            
            try {
                const response = await fetch('/api/management/org-account/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        action: 'pay_tax',
                        amount: amount
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(result.message || 'Налог успешно оплачен');
                    location.reload();
                } else {
                    taxError.textContent = result.error || 'Ошибка при оплате налога';
                    taxError.style.display = 'block';
                    payTaxBtn.disabled = false;
                    payTaxBtn.textContent = 'Оплатить налог';
                }
            } catch(err) {
                taxError.textContent = 'Ошибка соединения: ' + err.message;
                taxError.style.display = 'block';
                payTaxBtn.disabled = false;
                payTaxBtn.textContent = 'Оплатить налог';
            }
        });
    }
});
</script>
{% endblock %}

