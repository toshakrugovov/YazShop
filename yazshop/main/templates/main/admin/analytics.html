{% extends 'base.html' %}
{% load static %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - YazShop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã</h1>
        <div class="dashboard-actions">
            <a href="{% url 'management_dashboard' %}">‚Üê –ù–∞–∑–∞–¥</a>
            <a href="{% url 'admin_analytics_export_csv' %}?type=sales">–≠–∫—Å–ø–æ—Ä—Ç CSV (–ü—Ä–æ–¥–∞–∂–∏)</a>
            <a href="{% url 'admin_analytics_export_csv' %}?type=products">–≠–∫—Å–ø–æ—Ä—Ç CSV (–¢–æ–≤–∞—Ä—ã)</a>
            <a href="{% url 'admin_analytics_export_csv' %}?type=users">–≠–∫—Å–ø–æ—Ä—Ç CSV (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)</a>
            <a href="{% url 'admin_analytics_export_pdf' %}">–≠–∫—Å–ø–æ—Ä—Ç PDF</a>
        </div>
    </div>

    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ó–∞–∫–∞–∑–æ–≤ —Å–µ–≥–æ–¥–Ω—è</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ orders_today }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ó–∞–∫–∞–∑–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ orders_week }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ó–∞–∫–∞–∑–æ–≤ –∑–∞ –º–µ—Å—è—Ü</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ orders_month }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ó–∞–∫–∞–∑–æ–≤ –∑–∞ –≥–æ–¥</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ orders_year }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ revenue_today|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–í—ã—Ä—É—á–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ revenue_week|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–í—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ revenue_month|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–í—ã—Ä—É—á–∫–∞ –∑–∞ –≥–æ–¥</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ revenue_year|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <h3 style="font-size: 12px; margin-bottom: 8px;">–ù–∞–ª–æ–≥–∏ –∑–∞ –º–µ—Å—è—Ü (13%)</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ total_tax_month|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <h3 style="font-size: 12px; margin-bottom: 8px;">–ù–∞–ª–æ–≥–∏ –∑–∞ –≥–æ–¥ (13%)</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ total_tax_year|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h3 style="font-size: 12px; margin-bottom: 8px;">–ë–∞–ª–∞–Ω—Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ org_balance|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
            <h3 style="font-size: 12px; margin-bottom: 8px;">–†–µ–∑–µ—Ä–≤ –Ω–∞ –Ω–∞–ª–æ–≥–∏</h3>
            <div class="value" style="font-size: 20px; font-weight: 600;">{{ org_tax_reserve|floatformat:0 }} ‚ÇΩ</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ total_users }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ê–∫—Ç–∏–≤–Ω—ã—Ö</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ active_users }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ blocked_users }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ new_users_month }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ total_products }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–î–æ—Å—Ç—É–ø–Ω—ã—Ö</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ available_products }}</div>
        </div>
        <div class="stat-card" style="padding: 16px;">
            <h3 style="font-size: 12px; margin-bottom: 8px; color: var(--text-color-secondary);">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</h3>
            <div class="value" style="font-size: 24px; font-weight: 600;">{{ out_of_stock }}</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 32px;">
        <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
            <h3 style="margin: 0 0 16px 0; font-size: 18px;">–í—ã—Ä—É—á–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º</h3>
            <canvas id="revenueChart" style="max-height: 300px;"></canvas>
        </div>
        <div style="background: var(--bg-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
            <h3 style="margin: 0 0 16px 0; font-size: 18px;">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
            <canvas id="usersChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <div style="margin-top: 24px; background: var(--bg-color); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
        <h3 style="margin: 0 0 16px 0; font-size: 18px;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
        <canvas id="categoriesChart" style="max-height: 400px;"></canvas>
    </div>

    {% if product_of_week %}
    <div class="analytics-section">
        <h2>üèÜ –¢–æ–≤–∞—Ä –Ω–µ–¥–µ–ª–∏</h2>
        <div class="analytics-item">
            <div>
                <strong>{{ product_of_week.product_name }}</strong>
                <div style="font-size: 14px; color: var(--text-color-secondary); margin-top: 4px;">
                    –ü—Ä–æ–¥–∞–Ω–æ: {{ product_of_week.total_sold|default:0 }} —à—Ç. | 
                    –í—ã—Ä—É—á–∫–∞: {{ product_of_week.total_revenue|default:0 }} ‚ÇΩ
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if product_of_month %}
    <div class="analytics-section">
        <h2>üèÜ –¢–æ–≤–∞—Ä –º–µ—Å—è—Ü–∞</h2>
        <div class="analytics-item">
            <div>
                <strong>{{ product_of_month.product_name }}</strong>
                <div style="font-size: 14px; color: var(--text-color-secondary); margin-top: 4px;">
                    –ü—Ä–æ–¥–∞–Ω–æ: {{ product_of_month.total_sold|default:0 }} —à—Ç. | 
                    –í—ã—Ä—É—á–∫–∞: {{ product_of_month.total_revenue|default:0 }} ‚ÇΩ
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if popular_products %}
    <div class="analytics-section">
        <h2>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (–∑–∞ –º–µ—Å—è—Ü)</h2>
        {% for product in popular_products %}
        <div class="analytics-item">
            <div>
                <strong>{{ product.product_name }}</strong>
                <div style="font-size: 14px; color: var(--text-color-secondary); margin-top: 4px;">
                    –ü—Ä–æ–¥–∞–Ω–æ: {{ product.total_sold|default:0 }} —à—Ç. | 
                    –í—ã—Ä—É—á–∫–∞: {{ product.total_revenue|default:0 }} ‚ÇΩ
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if active_users_list %}
    <div class="analytics-section">
        <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∑–∞ –º–µ—Å—è—Ü)</h2>
        <div class="category-header">
            <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <div>–ó–∞–∫–∞–∑–æ–≤</div>
            <div>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
        </div>
        {% for user in active_users_list %}
        <div class="category-item">
            <div><strong>{{ user.username }}</strong></div>
            <div>{{ user.total_orders|default:0 }}</div>
            <div>{{ user.total_spent|default:0|floatformat:2 }} ‚ÇΩ</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if category_stats %}
    <div class="analytics-section">
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
        <div class="category-header">
            <div>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</div>
            <div>–¢–æ–≤–∞—Ä–æ–≤</div>
            <div>–ü—Ä–æ–¥–∞–Ω–æ</div>
            <div>–í—ã—Ä—É—á–∫–∞</div>
        </div>
        {% for cat in category_stats %}
        <div class="category-item">
            <div><strong>{{ cat.category_name }}</strong></div>
            <div>{{ cat.total_products|default:0 }}</div>
            <div>{{ cat.total_sold|default:0 }} —à—Ç.</div>
            <div>{{ cat.total_revenue|default:0 }} ‚ÇΩ</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// –í—ã—Ä—É—á–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
const revenueCtx = document.getElementById('revenueChart');
if (revenueCtx) {
    new Chart(revenueCtx, {
        type: 'bar',
        data: {
            labels: ['–°–µ–≥–æ–¥–Ω—è', '–ù–µ–¥–µ–ª—è', '–ú–µ—Å—è—Ü', '–ì–æ–¥'],
            datasets: [{
                label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                data: [{{ revenue_today|floatformat:0 }}, {{ revenue_week|floatformat:0 }}, {{ revenue_month|floatformat:0 }}, {{ revenue_year|floatformat:0 }}],
                backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(153, 102, 255, 0.6)'],
                borderColor: ['rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                        }
                    }
                }
            }
        }
    });
}

// –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∫—Ä—É–≥–ª–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
const usersCtx = document.getElementById('usersChart');
if (usersCtx) {
    new Chart(usersCtx, {
        type: 'doughnut',
        data: {
            labels: ['–ê–∫—Ç–∏–≤–Ω—ã–µ', '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ', '–ù–æ–≤—ã–µ –∑–∞ –º–µ—Å—è—Ü'],
            datasets: [{
                data: [{{ active_users }}, {{ blocked_users }}, {{ new_users_month }}],
                backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(255, 206, 86, 0.6)'],
                borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 99, 132, 1)', 'rgba(255, 206, 86, 1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (—Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
const categoriesCtx = document.getElementById('categoriesChart');
if (categoriesCtx && {{ category_stats|length }} > 0) {
    const categoryLabels = [
        {% for cat in category_stats %}
        '{{ cat.category_name|escapejs }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const categoryRevenue = [
        {% for cat in category_stats %}
        {{ cat.total_revenue|default:0|floatformat:0 }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    new Chart(categoriesCtx, {
        type: 'bar',
        data: {
            labels: categoryLabels,
            datasets: [{
                label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
                data: categoryRevenue,
                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                borderColor: 'rgba(153, 102, 255, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}

