{% extends 'base.html' %}
{% load static %}

{% block title %}Оформление заказа - YazShop{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="checkout-content">
    <div class="checkout-header">
        <h1>Оформление заказа</h1>
        <a href="{% url 'cart' %}">← Вернуться в корзину</a>
    </div>

    <form method="post" class="checkout-container" id="checkout-form">
        {% csrf_token %}
        <input type="hidden" name="saved_payment_id" id="saved_payment_id_input" value="">

        <!-- Левая колонка - Форма -->
        <div class="checkout-form">
            <!-- Адрес доставки -->
            <div class="form-section">
                <h2>Адрес доставки</h2>
                {% if addresses %}
                <div class="radio-group">
                    {% for address in addresses %}
                    <div class="radio-item">
                        <input type="radio" name="address_id" id="address_{{ address.id }}" value="{{ address.id }}" {% if address.is_primary %}checked{% endif %} required>
                        <label for="address_{{ address.id }}">
                            <div><strong>{{ address.address_title|default:"Адрес" }}</strong></div>
                            <div class="radio-item-info">
                                {{ address.city_name }}, {{ address.street_name }}, {{ address.house_number }}{% if address.apartment_number %}, кв. {{ address.apartment_number }}{% endif %}
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p>У вас нет сохраненных адресов. <a href="{% url 'addresses' %}">Добавить адрес</a></p>
                {% endif %}
            </div>

            <!-- Способ оплаты -->
            <div class="form-section">
                <h2>Способ оплаты</h2>
                <div class="radio-item" style="margin-bottom: 12px;">
                    <input type="radio" name="payment_method" id="payment_cash" value="cash" checked>
                    <label for="payment_cash">
                        <div><strong>Оплата наличными</strong></div>
                        <div class="radio-item-info">Оплата при получении заказа</div>
                    </label>
                </div>
                <div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">или</div>

                {% if user_balance > 0 %}
                <div class="radio-item" style="margin-bottom: 12px;">
                    <input type="radio" name="payment_method" id="payment_balance" value="balance" {% if user_balance >= cart.total_price %}{% else %}disabled{% endif %}>
                    <label for="payment_balance">
                        <div><strong>Оплата с баланса</strong></div>
                        <div class="radio-item-info">Баланс: <strong>{{ user_balance }} ₽</strong>{% if user_balance < cart.total_price %}<span style="color: #e74c3c;"> (Недостаточно средств)</span>{% endif %}</div>
                    </label>
                </div>
                <div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">или</div>
                {% endif %}

                {% if saved_payments %}
                <div class="radio-group" style="margin-bottom: 20px;">
                    {% for payment in saved_payments %}
                    <div class="radio-item" data-card-balance="{{ payment.balance }}" data-card-id="{{ payment.id }}">
                        <input type="radio" name="payment_method" id="saved_payment_{{ payment.id }}" value="card" data-saved-id="{{ payment.id }}">
                        <label for="saved_payment_{{ payment.id }}">
                            <div><strong>{{ payment.card_type|upper|default:"CARD" }} {{ payment.mask_card_number }}</strong></div>
                            <div class="radio-item-info">
                                Баланс: <strong>{{ payment.balance }} ₽</strong>
                                {% if payment.is_default %} (Основной){% endif %}
                                <span class="insufficient-funds" style="color: #e74c3c; display: none;"> (Недостаточно средств)</span>
                            </div>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div style="text-align: center; margin: 16px 0; color: var(--text-color-secondary);">или</div>
                {% endif %}

                <div class="radio-item">
                    <input type="radio" name="payment_method" id="new_payment" value="card">
                    <label for="new_payment"><strong>Новая карта</strong></label>
                </div>

                <div id="new-card-form" style="margin-top: 16px; {% if saved_payments %}display: none;{% endif %}">
                    <div class="form-group">
                        <label for="card_number">Номер карты *</label>
                        <input type="text" id="card_number" name="card_number" placeholder="1234 5678 9012 3456" maxlength="19" pattern="[0-9\s]+" {% if not saved_payments %}required{% endif %}>
                    </div>
                    <div class="form-group">
                        <label for="card_holder_name">Имя держателя карты *</label>
                        <input type="text" id="card_holder_name" name="card_holder_name" placeholder="IVAN IVANOV" {% if not saved_payments %}required{% endif %}>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry_month">Месяц *</label>
                            <input type="text" id="expiry_month" name="expiry_month" placeholder="MM" maxlength="2" pattern="[0-9]{2}" {% if not saved_payments %}required{% endif %}>
                        </div>
                        <div class="form-group">
                            <label for="expiry_year">Год *</label>
                            <input type="text" id="expiry_year" name="expiry_year" placeholder="YYYY" maxlength="4" pattern="[0-9]{4}" {% if not saved_payments %}required{% endif %}>
                        </div>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="save_card" name="save_card">
                        <label for="save_card">Сохранить данные карты для следующих покупок</label>
                    </div>
                </div>
            </div>

            <!-- Промокод -->
            <div class="form-section">
                <h2>Промокод</h2>
                <div class="form-group">
                    <div class="promo-section">
                        <input type="text" id="promo_code" name="promo_code" placeholder="Введите промокод">
                        <button type="button" id="apply_promo_btn">Применить</button>
                    </div>
                    <div id="promo_message" style="margin-top:8px; font-size:12px; color:#e74c3c; display:none;"></div>
                </div>
            </div>
        </div>

        <!-- Правая колонка - Итоговая информация -->
        <div class="checkout-summary">
            <h2>Итого</h2>

            <div class="cart-items-summary">
                {% for item in cart.items.all %}
                <div class="cart-item-summary">
                    {% if item.product.main_image_url %}
                    <img src="{{ item.product.main_image_url }}" alt="{{ item.product.product_name }}" class="cart-item-image">
                    {% else %}
                    <div class="cart-item-image" style="display: flex; align-items: center; justify-content: center; color: var(--text-color-secondary); font-size: 10px;">Нет изображения</div>
                    {% endif %}
                    <div class="cart-item-info">
                        <div class="cart-item-name">{{ item.product.product_name }}</div>
                        <div class="cart-item-details">{% if item.size %}Размер: {{ item.size.size_label }} • {% endif %}Количество: {{ item.quantity }}</div>
                    </div>
                    <div class="cart-item-price">{{ item.subtotal }} ₽</div>
                </div>
                {% endfor %}
            </div>

            <div class="summary-item">
                <span class="summary-item-label">Товары:</span>
                <span class="summary-item-value" id="subtotal-value">{{ subtotal }} ₽</span>
            </div>
            <div class="summary-item" id="discount-item" style="display: none;">
                <span class="summary-item-label discount">Скидка:</span>
                <span class="summary-item-value discount" id="discount-value">0 ₽</span>
            </div>
            <div class="summary-item">
                <span class="summary-item-label">Доставка:</span>
                <span class="summary-item-value" id="delivery-value">{{ delivery_cost }} ₽</span>
            </div>
            <div class="summary-item">
                <span class="summary-item-label">НДС {{ vat_rate }}%:</span>
                <span class="summary-item-value" id="vat-value">{{ vat_amount }} ₽</span>
            </div>
            <div class="summary-item total">
                <span class="summary-item-label">Итого:</span>
                <span class="summary-item-value" id="total-value">{{ total_with_vat }} ₽</span>
            </div>

            <button type="submit" class="submit-button" {% if not addresses %}disabled{% endif %}>Оформить заказ</button>
        </div>
    </form>
</div>

<script>
function parseAmount(text) { 
    const cleaned = text.replace(/[^\d.,]/g, ''); 
    return parseFloat(cleaned.replace(',', '.')) || 0; 
}

function formatAmount(amount) { 
    return amount.toFixed(2) + ' ₽'; 
}

function getTotalAmount() {
    const subtotalText = document.getElementById('subtotal-value').textContent;
    const subtotal = parseAmount(subtotalText);
    const discountItem = document.getElementById('discount-item');
    let discount = 0;
    if (discountItem && discountItem.style.display !== 'none') {
        const discountText = document.getElementById('discount-value').textContent;
        discount = parseAmount(discountText);
    }
    const deliveryText = document.getElementById('delivery-value').textContent;
    const delivery = parseAmount(deliveryText);
    const amountAfterDiscount = subtotal - discount + delivery; // Товары - скидка + доставка
    const vatRate = 20;
    const vatRounded = Math.round((amountAfterDiscount * vatRate / 100) * 100) / 100;
    const totalRounded = Math.round((amountAfterDiscount + vatRounded) * 100) / 100;
    return totalRounded;
}

function calculateTotal() {
    const totalRounded = getTotalAmount();
    const vatElement = document.getElementById('vat-value');
    const totalElement = document.getElementById('total-value');
    if (vatElement) {
        const subtotalText = document.getElementById('subtotal-value').textContent;
        const subtotal = parseAmount(subtotalText);
        const discountItem = document.getElementById('discount-item');
        let discount = 0;
        if (discountItem && discountItem.style.display !== 'none') {
            const discountText = document.getElementById('discount-value').textContent;
            discount = parseAmount(discountText);
        }
        const deliveryText = document.getElementById('delivery-value').textContent;
        const delivery = parseAmount(deliveryText);
        const amountAfterDiscount = subtotal - discount + delivery; // Товары - скидка + доставка
        const vatRate = 20;
        const vatRounded = Math.round((amountAfterDiscount * vatRate / 100) * 100) / 100;
        vatElement.textContent = formatAmount(vatRounded);
    }
    if (totalElement) totalElement.textContent = formatAmount(totalRounded);
    updateCardBalances();
    updateSubmitButton();
}

function updateCardBalances() {
    const totalAmount = getTotalAmount();
    document.querySelectorAll('.radio-item[data-card-balance]').forEach(cardItem => {
        const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
        const insufficientFundsSpan = cardItem.querySelector('.insufficient-funds');
        const radioInput = cardItem.querySelector('input[type="radio"]');
        
        if (cardBalance < totalAmount) {
            if (insufficientFundsSpan) insufficientFundsSpan.style.display = 'inline';
            if (radioInput) {
                radioInput.disabled = true;
                if (radioInput.checked) {
                    // Если выбранная карта стала недоступна, переключаем на наличные
                    const cashRadio = document.getElementById('payment_cash');
                    if (cashRadio) cashRadio.checked = true;
                    cashRadio.dispatchEvent(new Event('change'));
                }
            }
        } else {
            if (insufficientFundsSpan) insufficientFundsSpan.style.display = 'none';
            if (radioInput) radioInput.disabled = false;
        }
    });
}

function updateSubmitButton() {
    const submitButton = document.querySelector('.submit-button');
    if (!submitButton) return;
    
    const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
    if (!selectedPayment) {
        submitButton.disabled = true;
        return;
    }
    
    const paymentMethod = selectedPayment.value;
    const totalAmount = getTotalAmount();
    let canSubmit = true;
    
    if (paymentMethod === 'balance') {
        const balanceText = document.querySelector('#payment_balance')?.closest('.radio-item')?.querySelector('.radio-item-info strong')?.textContent;
        const balance = balanceText ? parseAmount(balanceText) : 0;
        if (balance < totalAmount) {
            canSubmit = false;
        }
    } else if (paymentMethod === 'card') {
        const savedPaymentId = selectedPayment.getAttribute('data-saved-id');
        if (savedPaymentId) {
            // Проверяем баланс сохраненной карты
            const cardItem = document.querySelector(`.radio-item[data-card-id="${savedPaymentId}"]`);
            if (cardItem) {
                const cardBalance = parseFloat(cardItem.getAttribute('data-card-balance')) || 0;
                if (cardBalance < totalAmount) {
                    canSubmit = false;
                }
            }
        } else if (selectedPayment.id === 'new_payment') {
            // Для новой карты проверяем, заполнены ли все поля и отмечен ли чекбокс сохранения
            const saveCardCheckbox = document.getElementById('save_card');
            if (!saveCardCheckbox || !saveCardCheckbox.checked) {
                canSubmit = false;
            } else {
                // Если карта будет сохранена, нужно проверить её баланс (но у новой карты баланс 0)
                // Поэтому для новой карты без сохранения - не разрешаем
                canSubmit = false;
            }
        }
    }
    
    // Также проверяем наличие адреса
    const addressSelected = document.querySelector('input[name="address_id"]:checked');
    if (!addressSelected) {
        canSubmit = false;
    }
    
    submitButton.disabled = !canSubmit;
}

// Переключение между способами оплаты
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const newCardForm = document.getElementById('new-card-form');
        const paymentMethod = this.value;
        if (paymentMethod === 'cash' || paymentMethod === 'balance') {
            newCardForm.style.display = 'none';
            ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.required = false;
            });
        } else if (paymentMethod === 'card') {
            const savedPaymentId = this.getAttribute('data-saved-id');
            if (this.id === 'new_payment' || !savedPaymentId) {
                newCardForm.style.display = 'block';
                ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.required = true;
                });
            } else {
                newCardForm.style.display = 'none';
                ['card_number','card_holder_name','expiry_month','expiry_year'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.required = false;
                });
            }
        }
        updateSubmitButton();
    });
});

// Отслеживание изменений адреса
document.querySelectorAll('input[name="address_id"]').forEach(radio => {
    radio.addEventListener('change', function() {
        updateSubmitButton();
    });
});

// Отслеживание изменений чекбокса сохранения карты
const saveCardCheckbox = document.getElementById('save_card');
if (saveCardCheckbox) {
    saveCardCheckbox.addEventListener('change', function() {
        updateSubmitButton();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if(document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for(let cookie of cookies){
            cookie = cookie.trim();
            if(cookie.startsWith(name + '=')){
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    if(!cookieValue){
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if(csrfInput) cookieValue = csrfInput.value;
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
    if (selectedPayment) selectedPayment.dispatchEvent(new Event('change'));
    calculateTotal();
    updateCardBalances();
    updateSubmitButton();

    const applyBtn = document.getElementById('apply_promo_btn');
    if (applyBtn) {
        applyBtn.addEventListener('click', function() {
            const codeInput = document.getElementById('promo_code');
            const message = document.getElementById('promo_message');
            if (!codeInput || !codeInput.value.trim()) {
                if (message) { message.textContent = 'Введите промокод'; message.style.display = 'block'; }
                return;
            }
            const formData = new FormData();
            formData.append('promo_code', codeInput.value.trim());
            fetch('/api/validate-promo/', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    promo_code: codeInput.value.trim(),
                    cart_total: parseFloat(document.getElementById('subtotal-value').textContent.replace(/\s/g, '').replace('₽', '')) || 0
                })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    const discountItem = document.getElementById('discount-item');
                    const discountValue = document.getElementById('discount-value');
                    const vatValue = document.getElementById('vat-value');
                    const totalValue = document.getElementById('total-value');
                    if (discountItem) discountItem.style.display = 'flex';
                    if (discountValue) discountValue.textContent = formatAmount(parseFloat(data.discount));
                    if (vatValue) vatValue.textContent = formatAmount(parseFloat(data.vat_amount));
                    if (totalValue) totalValue.textContent = formatAmount(parseFloat(data.total));
                    if (message) { message.textContent = 'Промокод применен (' + data.discount_percent + '%)'; message.style.color = '#28a745'; message.style.display = 'block'; }
                    // Обновляем доставку, если она есть в ответе
                    if (data.delivery !== undefined) {
                        const deliveryValue = document.getElementById('delivery-value');
                        if (deliveryValue) deliveryValue.textContent = formatAmount(parseFloat(data.delivery));
                    }
                    updateSubmitButton();
                } else {
                    if (message) { message.textContent = data.error || 'Промокод не принят'; message.style.color = '#e74c3c'; message.style.display = 'block'; }
                }
            }).catch(() => {
                if (message) { message.textContent = 'Ошибка проверки промокода'; message.style.color = '#e74c3c'; message.style.display = 'block'; }
            });
        });
    }
});

document.getElementById('checkout-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
    const submitButton = document.querySelector('.submit-button');
    
    if (submitButton && submitButton.disabled) {
        alert('Недостаточно средств для оформления заказа выбранным способом оплаты.');
        return false;
    }
    
    const addressId = document.querySelector('input[name="address_id"]:checked')?.value;
    if (!addressId) {
        alert('Выберите адрес доставки');
        return false;
    }
    
    const paymentMethod = selectedPayment?.value || 'cash';
    const savedPaymentId = selectedPayment?.getAttribute('data-saved-id') || '';
    
    const data = {
        address_id: parseInt(addressId),
        payment_method: paymentMethod,
        promo_code: document.getElementById('promo_code')?.value.trim() || ''
    };
    
    if (paymentMethod === 'card') {
        if (savedPaymentId) {
            data.saved_payment_id = savedPaymentId;
        } else {
            const cardNumber = document.getElementById('card_number')?.value.trim();
            const cardHolderName = document.getElementById('card_holder_name')?.value.trim();
            const expiryMonth = document.getElementById('expiry_month')?.value.trim();
            const expiryYear = document.getElementById('expiry_year')?.value.trim();
            const saveCard = document.getElementById('save_card')?.checked || false;
            
            if (cardNumber && cardHolderName && expiryMonth && expiryYear) {
                data.card_number = cardNumber;
                data.card_holder_name = cardHolderName;
                data.expiry_month = expiryMonth;
                data.expiry_year = expiryYear;
                data.save_card = saveCard;
            }
        }
    }
    
    submitButton.disabled = true;
    submitButton.textContent = 'Оформление...';
    
    try {
        const response = await fetch('/api/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success && result.order_id) {
            window.location.href = '/profile/orders/' + result.order_id + '/';
        } else {
            alert(result.error || 'Ошибка при оформлении заказа');
            submitButton.disabled = false;
            submitButton.textContent = 'Оформить заказ';
        }
    } catch(err) {
        alert('Ошибка соединения: ' + err.message);
        submitButton.disabled = false;
        submitButton.textContent = 'Оформить заказ';
    }
});

// Форматирование полей карты
['card_number'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\s/g, '');
            e.target.value = (v.match(/.{1,4}/g)?.join(' ') || v);
        });
    }
});

['expiry_month'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 2) v = v.slice(0, 2);
            if (v.length === 2 && parseInt(v) > 12) v = '12';
            e.target.value = v;
        });
    }
});

['expiry_year'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
        el.addEventListener('input', function(e) {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 4) v = v.slice(0, 4);
            e.target.value = v;
        });
    }
});
</script>
{% endblock %}




